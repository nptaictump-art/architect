<!-- templates/bookings.html -->
{% extends "base.html" %}

{% block content %}
<div class="h-[calc(100vh-64px)] flex flex-col bg-gray-50">
  <!-- Toolbar -->
  <div class="bg-white border-b px-4 py-2 shrink-0 flex flex-col md:flex-row md:items-center gap-2 shadow-sm z-30">
    <div class="flex p-1 rounded-lg shrink-0 overflow-x-auto hide-scrollbar gap-2">
      {% for tab_id, label, count in [
        ('PENDING', 'Chờ duyệt', pending_count),
        ('APPROVED', 'Đã duyệt', approved_count),
        ('ACTIVE', 'Đang mượn', active_count),
        ('WAITING_LOG', 'Chờ ghi sổ', waiting_log_count),
        ('HISTORY', 'Lịch sử', history_count)
      ] %}
        <button
          class="tab-btn flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all whitespace-nowrap border {{ 'bg-yellow-500 text-white shadow-lg shadow-yellow-200 border-yellow-600' if tab_id == 'PENDING' and active_tab == 'PENDING' else '' }}
                 {{ 'bg-green-600 text-white shadow-lg shadow-green-200 border-green-700' if tab_id == 'APPROVED' and active_tab == 'APPROVED' else '' }}
                 {{ 'bg-blue-600 text-white shadow-lg shadow-blue-200 border-blue-700' if tab_id == 'ACTIVE' and active_tab == 'ACTIVE' else '' }}
                 {{ 'bg-orange-600 text-white shadow-lg shadow-orange-200 border-orange-700 animate-pulse' if tab_id == 'WAITING_LOG' and active_tab == 'WAITING_LOG' else '' }}
                 {{ 'bg-gray-700 text-white shadow-lg shadow-gray-300 border-gray-800' if tab_id == 'HISTORY' and active_tab == 'HISTORY' else '' }}
                 {{ 'text-yellow-700 bg-yellow-50 hover:bg-yellow-100 border-yellow-200' if tab_id == 'PENDING' and active_tab != 'PENDING' else '' }}
                 {{ 'text-green-700 bg-green-50 hover:bg-green-100 border-green-200' if tab_id == 'APPROVED' and active_tab != 'APPROVED' else '' }}
                 {{ 'text-blue-700 bg-blue-50 hover:bg-blue-100 border-blue-200' if tab_id == 'ACTIVE' and active_tab != 'ACTIVE' else '' }}
                 {{ ('text-orange-700 bg-orange-50 hover:bg-orange-100 border-orange-200 font-extrabold animate-pulse' if waiting_log_count > 0 else 'text-gray-500 bg-gray-50 hover:bg-gray-100 border-gray-200') if tab_id == 'WAITING_LOG' and active_tab != 'WAITING_LOG' else '' }}
                 {{ 'text-gray-700 bg-gray-100 hover:bg-gray-200 border-gray-300' if tab_id == 'HISTORY' and active_tab != 'HISTORY' else '' }}"
          data-tab="{{ tab_id }}"
          onclick="switchTab('{{ tab_id }}')"
        >
          {% if tab_id == 'PENDING' %}<i data-lucide="clock" class="w-4 h-4"></i>
          {% elif tab_id == 'APPROVED' %}<i data-lucide="check-circle" class="w-4 h-4"></i>
          {% elif tab_id == 'ACTIVE' %}<i data-lucide="play-circle" class="w-4 h-4"></i>
          {% elif tab_id == 'WAITING_LOG' %}<i data-lucide="clipboard-list" class="w-4 h-4"></i>
          {% elif tab_id == 'HISTORY' %}<i data-lucide="file-check" class="w-4 h-4"></i>
          {% endif %}
          <span>{{ label }}</span>
          <span class="px-1.5 py-0.5 rounded-full text-[10px] bg-white/50 text-current backdrop-blur-sm">{{ count }}</span>
        </button>
      {% endfor %}
    </div>

    <div class="flex flex-1 items-center gap-2 ml-auto w-full md:w-auto justify-end">
      <div class="relative flex-1 min-w-[150px] max-w-xs">
        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-3.5 h-3.5"></i>
        <input type="text" id="searchInput" placeholder="Tìm kiếm..." class="w-full pl-9 pr-2 py-1.5 border rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm bg-gray-50 focus:bg-white" />
      </div>

      {% if active_tab == 'HISTORY' %}
        <div class="relative shrink-0">
          <select id="yearSelect" class="border rounded-lg pl-3 pr-8 py-1.5 text-sm bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none appearance-none font-bold text-gray-700">
            {% for year in history_years %}
              <option value="{{ year }}" {{ 'selected' if year == selected_history_year else '' }}>{{ year }}</option>
            {% endfor %}
          </select>
          <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none w-3.5 h-3.5"></i>
        </div>
      {% endif %}

      {% if current_user.role in ['ADMIN', 'STAFF'] %}
        <a href="/admin" class="flex items-center gap-1 bg-white border border-gray-200 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-50 shadow-sm text-xs font-bold whitespace-nowrap">
          <i data-lucide="settings" class="w-3.5 h-3.5"></i> <span class="hidden sm:inline">Quản lý</span>
        </a>
      {% endif %}

      <a href="#" onclick="alert('Chức năng đăng ký mới chưa hỗ trợ trong phiên bản HTML thuần'); return false;"
         class="flex items-center gap-1 bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 shadow-sm text-xs font-bold whitespace-nowrap">
        <i data-lucide="plus" class="w-3.5 h-3.5"></i> <span class="hidden sm:inline">Đăng ký</span>
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col p-2 bg-gray-50 overflow-hidden">
    <div class="bg-white rounded-lg border shadow-sm flex-1 overflow-hidden">
      <div class="flex-1 overflow-auto">
        <table class="w-full text-left min-w-[1000px]">
          <thead class="bg-gray-100 text-gray-700 text-xs font-bold uppercase sticky top-0 z-20 shadow-sm">
            <tr>
              {% if active_tab == 'HISTORY' %}
                <th class="p-3 border-b text-center w-12">STT</th>
                <th class="p-3 border-b min-w-[180px]">Thời gian</th>
                <th class="p-3 border-b min-w-[200px]">Thiết bị & Người dùng</th>
                <th class="p-3 border-b min-w-[250px]">Chi tiết</th>
                <th class="p-3 border-b text-center">Trạng thái</th>
                <th class="p-3 border-b text-center">Minh chứng</th>
              {% elif active_tab == 'WAITING_LOG' %}
                <th class="p-3 border-b">Thời gian trả</th>
                <th class="p-3 border-b">Thiết bị</th>
                <th class="p-3 border-b">Người sử dụng</th>
                <th class="p-3 border-b">Trạng thái</th>
                <th class="p-3 border-b text-right">Hành động</th>
              {% else %}
                <th class="p-3 border-b">Thiết bị</th>
                <th class="p-3 border-b">Người đăng ký</th>
                <th class="p-3 border-b">Thời gian mượn</th>
                <th class="p-3 border-b">Trạng thái</th>
                <th class="p-3 border-b text-right">Hành động</th>
              {% endif %}
            </tr>
          </thead>
          <tbody class="divide-y text-sm">
            {% if filtered_bookings %}
              {% for b in filtered_bookings %}
                <tr class="hover:bg-gray-50">
                  {% if active_tab == 'HISTORY' %}
                    <td class="p-3 text-center text-gray-500">{{ loop.index }}</td>
                    <td class="p-3">
                      <div class="text-xs">
                        <div>Mượn: {{ b.startTime | datetime_vn }}</div>
                        <div class="pt-1 border-t border-dashed border-gray-200">Trả: {{ b.endTime | datetime_vn if b.endTime else '---' }}</div>
                      </div>
                    </td>
                    <td class="p-3">
                      <div class="mb-2"><strong>{{ b.equipmentName }}</strong><br><span class="text-xs font-mono bg-gray-100 px-1 rounded">{{ b.equipmentCode }}</span></div>
                      <div class="text-xs text-gray-600">{{ b.guestName }} ({{ b.userCode }})</div>
                    </td>
                    <td class="p-3">
                      <div>{{ b.purpose }}</div>
                      {% if b.rejectionReason %}
                        <div class="text-red-600 text-xs">Lý do: {{ b.rejectionReason }}</div>
                      {% endif %}
                    </td>
                    <td class="p-3 text-center">
                      {% if b.status == 'COMPLETED' %}<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Hoàn thành</span>
                      {% elif b.status == 'CANCELLED' %}<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">Hủy</span>
                      {% elif b.status == 'REJECTED' %}<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Từ chối</span>
                      {% endif %}
                    </td>
                    <td class="p-3 text-center"><span class="text-gray-400">--</span></td> <!-- minh chứng: cần thêm logs -->
                  {% elif active_tab == 'WAITING_LOG' %}
                    <td class="p-3">{{ b.endTime | datetime_vn }}</td>
                    <td class="p-3"><strong>{{ b.equipmentName }}</strong><br><span class="text-xs">{{ b.equipmentCode }}</span></td>
                    <td class="p-3">{{ b.guestName }}<br><span class="text-xs">MSSV: {{ b.userCode }}</span></td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-800">Chưa ghi nhật ký</span></td>
                    <td class="p-3 text-right">
                      {% if current_user.role in ['ADMIN', 'STAFF'] %}
                        <button class="px-3 py-1.5 rounded text-xs font-bold border border-yellow-300 text-yellow-700 hover:bg-yellow-50">Gửi Email</button>
                      {% endif %}
                      <a href="/log/{{ b.id }}" class="px-3 py-1.5 rounded text-xs font-bold bg-blue-600 text-white">Bổ sung nhật ký</a>
                    </td>
                  {% else %}
                    <td class="p-3"><strong>{{ b.equipmentName }}</strong><br><span class="text-xs">{{ b.equipmentCode }}</span></td>
                    <td class="p-3">{{ b.guestName }}<br><span class="text-xs">MSSV: {{ b.userCode }}</span></td>
                    <td class="p-3">
                      {{ b.startTime | datetime_vn }}<br>
                      đến {{ b.endTime | datetime_vn }}
                    </td>
                    <td class="p-3">
                      {% if b.status == 'PENDING' %}<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">Chờ duyệt</span>
                      {% elif b.status == 'APPROVED' %}<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Đã duyệt</span>
                      {% elif b.status == 'ACTIVE' %}<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">Đang mượn</span>
                      {% elif b.status == 'COMPLETED' %}<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">Đã trả</span>
                      {% elif b.status == 'CANCELLED' %}<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">Hủy</span>
                      {% elif b.status == 'REJECTED' %}<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Từ chối</span>
                      {% endif %}
                    </td>
                    <td class="p-3 text-right">
                      <!-- Hành động đơn giản: xem chi tiết -->
                      <a href="/booking/{{ b.id }}" class="text-blue-600 hover:underline text-xs">Chi tiết</a>
                      {% if current_user.role in ['ADMIN', 'STAFF'] and b.status == 'PENDING' %}
                        <br><a href="/api/bookings/{{ b.id }}/approve" class="text-green-600 text-xs">Duyệt</a>
                        <br><a href="/api/bookings/{{ b.id }}/reject" class="text-red-600 text-xs">Từ chối</a>
                      {% endif %}
                    </td>
                  {% endif %}
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="6" class="p-8 text-center text-gray-400">
                {% if active_tab == 'WAITING_LOG' %}
                  Tuyệt vời! Không có đơn nào cần bổ sung nhật ký.
                {% else %}
                  Không có dữ liệu.
                {% endif %}
              </td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  lucide.createIcons();

  // Tab switching (reload with query param)
  function switchTab(tab) {
    const url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.location.href = url.toString();
  }

  // Live search (optional, client-side)
  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(term) ? '' : 'none';
    });
  });

  // Year change
  document.getElementById('yearSelect')?.addEventListener('change', (e) => {
    const url = new URL(window.location);
    url.searchParams.set('year', e.target.value);
    window.location.href = url.toString();
  });
</script>
{% endblock %}