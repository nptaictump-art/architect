{% extends "base.html" %}
{% block content %}
<div class="h-[calc(100vh-64px)] -m-4 md:-m-6 flex bg-gray-100 overflow-hidden relative">

  <!-- SIDEBAR -->
  <div class="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0 z-10 hidden md:flex">
    <div class="p-4 border-b border-gray-100 bg-gray-50 space-y-3">
      <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span> Ni√™n ƒë·ªô ki·ªÉm k√™
      </h2>
      {% if can_edit %}
      <button id="btnOpenYearModal"
        class="w-full bg-white border border-gray-300 text-gray-600 px-3 py-2 rounded-lg text-sm font-bold hover:border-blue-600 hover:text-blue-600 transition-all flex items-center justify-center gap-2 shadow-sm active:scale-95">
        + Th√™m NƒÉm M·ªõi
      </button>
      {% endif %}
    </div>
    <div class="flex-1 overflow-y-auto p-2 space-y-1" id="yearList"></div>
  </div>

  <!-- MAIN -->
  <div class="flex-1 flex flex-col min-w-0 h-full">
    <div class="bg-white border-b px-6 py-4 flex flex-col gap-4 shadow-sm shrink-0">
      <div class="flex flex-col md:flex-row justify-between md:items-center gap-2">
        <h2 class="text-xl font-bold text-gray-800">
          Danh s√°ch Ki·ªÉm k√™ NƒÉm <span id="selectedYearText"></span>
        </h2>

        <!-- Tabs -->
        <div class="flex bg-gray-100 p-1 rounded-lg self-start md:self-auto">
          <button data-tab="ACTIVE" class="tabBtn px-4 py-1.5 rounded-md text-sm font-bold transition-all">
            Danh s√°ch <span id="countActive" class="ml-1 text-[10px] px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-600">0</span>
          </button>
          <button data-tab="LIQUIDATION" class="tabBtn px-4 py-1.5 rounded-md text-sm font-bold transition-all">
            H·ªì s∆° Thanh l√Ω <span id="countLiquidation" class="ml-1 text-[10px] px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-600">0</span>
          </button>
          <button data-tab="TRASH" class="tabBtn px-4 py-1.5 rounded-md text-sm font-bold transition-all">
            Th√πng r√°c <span id="countTrash" class="ml-1 text-[10px] px-1.5 py-0.5 rounded-full bg-gray-200 text-gray-600">0</span>
          </button>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-3">
        <!-- Mobile year select -->
        <div class="md:hidden">
          <select id="yearSelectMobile" class="w-full border rounded-lg px-3 py-2 bg-gray-50 font-bold text-gray-700"></select>
        </div>

        <!-- Search -->
        <div class="relative flex-1">
          <input id="searchInput" type="text" placeholder="T√¨m ki·∫øm ƒë·ª£t ki·ªÉm k√™..."
            class="w-full pl-4 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 text-sm" />
        </div>

        <!-- Tools -->
        {% if can_edit %}
        <div class="relative shrink-0">
          <button id="btnTools"
            class="flex items-center gap-1 bg-white border border-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-50 shadow-sm text-sm font-bold whitespace-nowrap">
            Qu·∫£n l√Ω
          </button>
          <div id="toolsMenu" class="hidden absolute right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-xl p-1.5 z-50 min-w-[180px]">
            <div class="px-2 py-1 text-[10px] font-bold text-gray-400 uppercase tracking-wider">C√¥ng c·ª•</div>
            <button id="btnExportMaster"
              class="w-full text-left flex items-center gap-2 text-green-700 hover:bg-green-50 px-3 py-2 rounded-lg text-xs font-bold">
              Xu·∫•t Excel danh s√°ch
            </button>
            <button id="btnCleanYear"
              class="w-full text-left flex items-center gap-2 text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg text-xs font-bold">
              D·ªçn d·∫πp d·ªØ li·ªáu (ƒë∆∞a v√†o r√°c)
            </button>
          </div>
        </div>

        <button id="btnOpenSessionModal"
          class="flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow-md font-bold text-sm active:scale-95 transition-transform whitespace-nowrap">
          + T·∫°o ƒë·ª£t m·ªõi
        </button>
        {% endif %}
      </div>
    </div>

    <!-- LIST -->
    <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50">
      <div class="hidden md:flex px-6 py-3 bg-gray-100 text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 rounded-t-lg mx-auto max-w-5xl">
        <div class="w-32">Ng√†y ki·ªÉm k√™</div>
        <div class="flex-1">T√™n ƒë·ª£t & ƒê∆°n v·ªã</div>
        <div class="w-32">Tr·∫°ng th√°i</div>
        <div class="w-32 text-right">H√†nh ƒë·ªông</div>
      </div>

      <div id="sessionList" class="flex flex-col gap-0 pb-10 max-w-5xl mx-auto"></div>

      <div id="emptyState" class="hidden py-16 text-center text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-white mt-2 max-w-5xl mx-auto">
        <div class="text-lg font-bold text-gray-300 mb-2">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
        <p id="emptyText"></p>
      </div>
    </div>
  </div>

</div>

<!-- YEAR MODAL -->
<div id="yearModal" class="hidden fixed inset-0 z-[1200] flex items-center justify-center bg-black/50 p-4">
  <div class="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <h3 class="font-bold text-lg text-gray-800">Th√™m Ni√™n ƒë·ªô</h3>
      <button class="btnCloseModal text-gray-400 hover:text-gray-600">‚úï</button>
    </div>
    <p class="text-sm text-gray-600 mb-3">Nh·∫≠p nƒÉm b·∫°n mu·ªën t·∫°o danh s√°ch ki·ªÉm k√™ m·ªõi.</p>
    <input id="newYearInput" type="number" class="w-full border rounded-lg p-3 text-lg font-bold text-center text-blue-600" />
    <div class="flex justify-end gap-3 mt-6">
      <button class="btnCloseModal px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">H·ªßy</button>
      <button id="btnSaveNewYear" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow hover:bg-blue-700">OK, Th√™m</button>
    </div>
  </div>
</div>

<!-- SESSION MODAL -->
<div id="sessionModal" class="hidden fixed inset-0 z-[1050] flex items-center justify-center bg-black/50 p-4">
  <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
    <div class="flex justify-between items-center mb-4">
      <h3 id="sessionModalTitle" class="font-bold text-xl text-gray-800"></h3>
      <button class="btnCloseSessionModal text-gray-400 hover:text-gray-600">‚úï</button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Ng√†y th·ª±c hi·ªán</label>
        <input id="formDate" type="date" class="w-full border rounded-lg p-2.5 text-sm font-bold text-gray-700" />
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">T√™n ƒë·ª£t ki·ªÉm k√™</label>
        <input id="formTitle" class="w-full border rounded-lg p-2.5 font-medium" placeholder="VD: Ki·ªÉm k√™ Qu√Ω 1..." />
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Ph·∫°m vi</label>
        <select id="formScope" class="w-full border rounded-lg p-2.5 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">Th√†nh ph·∫ßn tham gia</label>
        <input id="formParticipants" class="w-full border rounded-lg p-2.5" placeholder="Ng∆∞·ªùi A, Ng∆∞·ªùi B..." />
      </div>
    </div>
    <div class="flex justify-end gap-3 mt-6">
      <button class="btnCloseSessionModal px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">H·ªßy</button>
      <button id="btnSaveSession" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-sm">L∆∞u</button>
    </div>
  </div>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="hidden fixed inset-0 z-[1050] flex flex-col bg-white">
  <div class="px-4 py-3 border-b flex justify-between items-center shadow-sm bg-gray-50 shrink-0">
    <div class="flex items-center gap-3">
      <button id="btnCloseView" class="p-1.5 hover:bg-gray-200 rounded-full">‚Üê</button>
      <div>
        <h2 id="viewTitle" class="text-lg font-bold text-gray-800"></h2>
        <div class="text-xs text-gray-500" id="viewMeta"></div>
      </div>
    </div>
    <div class="flex gap-2">
      <button id="btnExportSession" class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 shadow-sm text-xs font-bold">Excel</button>
      {% if can_edit %}
      <button id="btnSaveSessionDetail" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 shadow-sm text-xs font-bold">L∆∞u</button>
      {% endif %}
    </div>
  </div>

  <div class="flex-1 flex flex-col bg-gray-100 p-4 overflow-hidden">
    <div class="flex items-center justify-between mb-4 shrink-0">
      <input id="modalSearch" type="text" placeholder="T√¨m trong danh s√°ch..."
        class="border rounded-lg px-3 py-1.5 text-sm w-64" />
    </div>

    <div class="flex-1 bg-white rounded-xl shadow border overflow-hidden flex flex-col">
      <div class="flex-1 overflow-auto">
        <table class="w-full text-left border-collapse text-sm min-w-[1200px]">
          <thead class="bg-gray-100 text-gray-700 font-bold sticky top-0 z-10 border-b">
            <tr>
              <th class="p-3 border-r w-10 text-center">TT</th>
              <th class="p-3 border-r min-w-[200px]">T√™n Thi·∫øt B·ªã</th>
              <th class="p-3 border-r w-24">M√£ S·ªë</th>
              <th class="p-3 border-r min-w-[120px]">Model / Serial</th>
              <th class="p-3 border-r w-16 text-center">ƒêVT</th>
              <th class="p-3 border-r w-20 text-center">NƒÉm SD</th>
              <th class="p-3 border-r w-28 text-right">Nguy√™n gi√°</th>
              <th class="p-3 border-r min-w-[120px]">Ngu·ªìn / ƒê∆°n v·ªã</th>
              <th class="p-3 border-r min-w-[120px]">QL / Ng∆∞·ªùi nh·∫≠n</th>
              <th class="p-3 border-r w-16 text-center">SL S·ªï</th>
              <th class="p-3 border-r w-20 text-center bg-blue-50">SL Th·ª±c</th>
              <th class="p-3 border-r w-28 bg-blue-50">K·∫øt qu·∫£</th>
              <th class="p-3 bg-blue-50">Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="itemsTbody" class="divide-y"></tbody>
        </table>
      </div>
      <div class="p-2 border-t bg-gray-50 flex justify-between items-center text-xs shrink-0">
        <div id="itemsCount">T·ªïng: 0 thi·∫øt b·ªã</div>
      </div>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM -->
<div id="deleteModal" class="hidden fixed inset-0 z-[1100] flex items-center justify-center bg-black/60 p-4">
  <div class="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl border-t-4 border-red-500">
    <div class="flex items-center gap-3 text-red-600 mb-4">
      <div class="text-2xl">‚ö†</div>
      <h3 class="font-bold text-xl text-gray-900">X√°c nh·∫≠n x√≥a?</h3>
    </div>
    <p class="text-gray-600 mb-6 text-sm">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
    <div class="flex justify-end gap-3">
      <button id="btnCancelDelete" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg font-medium text-sm">H·ªßy</button>
      <button id="btnConfirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-lg text-sm">X√≥a ngay</button>
    </div>
  </div>
</div>

<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // ====== DATA FROM SERVER ======
  const DATA = {{ page_data | safe }};
  let state = {
    sessions: DATA.inventory_sessions || [],
    equipment: DATA.equipment || [],
    users: DATA.users || [],
    currentUser: DATA.current_user || null,
    canEdit: DATA.can_edit || false,
    extraYears: [],
    activeTab: "ACTIVE",
    selectedYear: new Date().getFullYear(),
    searchTerm: "",
    viewing: null,
    deleteTargetId: null,
  };

  // ====== HELPERS ======
  const $ = (id) => document.getElementById(id);
  const show = (el) => el.classList.remove("hidden");
  const hide = (el) => el.classList.add("hidden");
  const fmtDate = (s) => {
    try { return new Date(s).toLocaleDateString("vi-VN"); } catch { return s; }
  };

  function availableYears() {
    const y = new Set([new Date().getFullYear(), ...state.extraYears]);
    state.sessions.forEach(s => {
      const yy = new Date(s.date).getFullYear();
      if (!isNaN(yy)) y.add(yy);
    });
    return Array.from(y).sort((a,b)=>b-a);
  }

  function countsForYear(year) {
    let active=0, trash=0, liquidation=0;
    state.sessions.forEach(s => {
      if (new Date(s.date).getFullYear() !== year) return;
      if (s.isDeleted) trash++;
      else if (s.type === "LIQUIDATION") liquidation++;
      else active++;
    });
    return {active, trash, liquidation};
  }

  function filteredSessions() {
    return state.sessions
      .filter(s => new Date(s.date).getFullYear() === state.selectedYear)
      .filter(s => {
        const q = state.searchTerm.toLowerCase();
        const ok = (s.title||"").toLowerCase().includes(q) || (s.scope||"").toLowerCase().includes(q);
        if (!ok) return false;
        const isDeleted = !!s.isDeleted;
        if (state.activeTab === "TRASH") return isDeleted;
        if (state.activeTab === "LIQUIDATION") return !isDeleted && s.type === "LIQUIDATION";
        return !isDeleted && (s.type === "REGULAR" || !s.type);
      })
      .sort((a,b)=> new Date(b.date).getTime() - new Date(a.date).getTime());
  }

  function uniqueDepartments() {
    const depts = state.equipment.map(e=>e.usingDepartment).filter(Boolean);
    return Array.from(new Set(depts)).sort();
  }

  function managerNameForEquipment(e) {
    const u = state.users.find(x => x.id === e.managerId);
    return u ? u.name : (e.managerId || "");
  }

  function buildItemsForScope(scope) {
    let list = state.equipment;
    if (scope !== "To√†n b·ªô") list = list.filter(e => e.usingDepartment === scope);

    return list.map(e => ({
      equipmentId: e.id,
      equipmentName: e.name,
      equipmentCode: e.code,
      model: e.model || "",
      serial: e.serial || "",
      location: e.location || "",
      unit: e.unit || "",
      yearOfUse: e.yearOfUse || "",
      price: e.price || "",
      receiver: e.receiver || "",
      manager: managerNameForEquipment(e),
      usingDepartment: e.usingDepartment || "",
      fundingSource: e.fundingSource || "",
      systemQty: e.quantity || 1,
      actualQty: e.quantity || 1,
      status: "MATCH",
      note: ""
    }));
  }

  // ====== RENDER ======
  function renderYears() {
    const years = availableYears();
    if (!years.includes(state.selectedYear)) state.selectedYear = years[0] || new Date().getFullYear();
    $("selectedYearText").textContent = state.selectedYear;

    // sidebar
    const list = $("yearList");
    if (list) {
      list.innerHTML = years.map(y => `
        <button class="w-full text-left px-4 py-3 rounded-lg flex items-center justify-between transition-all ${state.selectedYear===y?'bg-blue-50 text-blue-700 font-bold border border-blue-100':'text-gray-600 hover:bg-gray-100'}"
          data-year="${y}">
          <span>NƒÉm ${y}</span>
          <span>${state.selectedYear===y?'‚Ä∫':''}</span>
        </button>
      `).join("");
      list.querySelectorAll("button[data-year]").forEach(btn=>{
        btn.onclick = ()=> { state.selectedYear = Number(btn.dataset.year); syncAfterYearChange(); };
      });
    }

    // mobile select
    const sel = $("yearSelectMobile");
    if (sel) {
      sel.innerHTML = years.map(y => `<option value="${y}">NƒÉm ${y}</option>`).join("");
      sel.value = String(state.selectedYear);
      sel.onchange = ()=> { state.selectedYear = Number(sel.value); syncAfterYearChange(); };
    }

    // counts
    const c = countsForYear(state.selectedYear);
    $("countActive").textContent = c.active;
    $("countTrash").textContent = c.trash;
    $("countLiquidation").textContent = c.liquidation;
  }

  function renderTabs() {
    document.querySelectorAll(".tabBtn").forEach(btn=>{
      const tab = btn.dataset.tab;
      const active = (tab === state.activeTab);
      btn.classList.toggle("bg-white", active);
      btn.classList.toggle("shadow", active);
      btn.classList.toggle("text-blue-600", active && tab==="ACTIVE");
      btn.classList.toggle("text-orange-600", active && tab==="LIQUIDATION");
      btn.classList.toggle("text-red-600", active && tab==="TRASH");
      btn.classList.toggle("text-gray-500", !active);
      btn.onclick = ()=> { state.activeTab = tab; renderAll(); };
    });
  }

  function renderList() {
    const list = $("sessionList");
    const empty = $("emptyState");
    const emptyText = $("emptyText");
    const sessions = filteredSessions();

    if (!sessions.length) {
      list.innerHTML = "";
      show(empty);
      emptyText.textContent =
        state.activeTab==="ACTIVE" ? "Ch∆∞a c√≥ ƒë·ª£t ki·ªÉm k√™ n√†o trong nƒÉm n√†y." :
        state.activeTab==="LIQUIDATION" ? "Ch∆∞a c√≥ h·ªì s∆° thanh l√Ω n√†o." : "Th√πng r√°c tr·ªëng.";
      return;
    }
    hide(empty);

    list.innerHTML = sessions.map((s, idx) => {
      const statusLabel = (s.status==="COMPLETED") ? "Ho√†n th√†nh" : "ƒêang th·ª±c hi·ªán";
      const statusClass = (s.status==="COMPLETED") ? "bg-green-50 text-green-700 border-green-200" : "bg-yellow-50 text-yellow-700 border-yellow-200";
      const rowTone = (state.activeTab==="TRASH") ? "border-red-100 bg-red-50/10" : (state.activeTab==="LIQUIDATION" ? "border-orange-100 bg-orange-50/20" : "border-gray-200");
      return `
        <div class="group relative bg-white border-b border-l border-r hover:bg-gray-50 transition-colors p-4 flex flex-col md:flex-row md:items-center gap-4 cursor-pointer ${rowTone}"
          data-id="${s.id}">
          <div class="flex items-center gap-3 w-full md:w-32 shrink-0">
            <div class="flex items-center gap-2 text-gray-700">
              <div class="font-bold">${fmtDate(s.date)}</div>
            </div>
          </div>

          <div class="flex-1 min-w-0 w-full">
            <h3 class="font-bold text-gray-800 truncate group-hover:text-blue-600 transition-colors text-base">${s.title||""}</h3>
            <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 mt-1">
              <span class="flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded text-gray-600 font-medium">${s.scope||""}</span>
              ${s.participants ? `<span class="truncate">${s.participants}</span>` : ""}
            </div>
          </div>

          <div class="w-full md:w-32 shrink-0 flex items-center">
            <span class="inline-flex items-center gap-1 text-xs font-bold px-2.5 py-1 rounded-full border ${statusClass}">
              ${statusLabel}
            </span>
          </div>

          <div class="w-full md:w-32 shrink-0 flex justify-end items-center gap-2 mt-2 md:mt-0 pt-2 md:pt-0 border-t md:border-t-0"
            data-actions="1">
            ${renderActionsHtml(s)}
          </div>
        </div>
      `;
    }).join("");

    // row click
    list.querySelectorAll("div[data-id]").forEach(row=>{
      row.onclick = (e)=>{
        const actions = e.target.closest('[data-actions="1"]');
        if (actions) return;
        const id = row.dataset.id;
        const s = state.sessions.find(x=>x.id===id);
        if (!s) return;
        if (state.activeTab==="TRASH") return;
        openView(s);
      };
    });

    // bind action buttons
    list.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick = async (e)=>{
        e.stopPropagation();
        const act = btn.dataset.act;
        const id = btn.dataset.id;
        const s = state.sessions.find(x=>x.id===id);
        if (!s) return;

        if (act==="view") return openView(s);
        if (act==="edit") return openSessionModal(s);
        if (act==="toggle") {
          const next = (s.status==="OPEN") ? "COMPLETED" : "OPEN";
          await apiUpdateSession(id, { ...s, status: next });
        }
        if (act==="delete") return openDelete(id);
        if (act==="restore") return apiRestore(id);
        if (act==="destroy") return openDelete(id, true);
      };
    });
  }

  function renderActionsHtml(s) {
    const canEdit = state.canEdit;
    if (state.activeTab==="ACTIVE") {
      return `
        <button data-act="toggle" data-id="${s.id}" class="p-2 rounded-lg border shadow-sm ${s.status==="OPEN"?'text-green-600 bg-white border-green-200 hover:bg-green-50':'text-orange-600 bg-white border-orange-200 hover:bg-orange-50'}" title="ƒê·ªïi tr·∫°ng th√°i">
          ${s.status==="OPEN" ? "‚úì" : "‚Üª"}
        </button>
        <button data-act="view" data-id="${s.id}" class="text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg">Xem</button>
        ${canEdit ? `<button data-act="edit" data-id="${s.id}" class="p-2 rounded-lg hover:bg-blue-50 text-blue-600" title="S·ª≠a">‚úé</button>` : ""}
        ${canEdit ? `<button data-act="delete" data-id="${s.id}" class="p-2 rounded-lg hover:bg-red-50 text-red-600" title="ƒê∆∞a v√†o r√°c">üóë</button>` : ""}
      `;
    }
    if (state.activeTab==="LIQUIDATION") {
      return `<button data-act="view" data-id="${s.id}" class="text-xs font-bold text-orange-600 bg-orange-50 hover:bg-orange-100 border border-orange-200 px-3 py-1.5 rounded-lg">Xem H·ªì S∆°</button>`;
    }
    // TRASH
    return `
      <button data-act="restore" data-id="${s.id}" class="p-2 rounded-lg hover:bg-blue-50 text-blue-600" title="Kh√¥i ph·ª•c">‚Üª</button>
      <button data-act="destroy" data-id="${s.id}" class="p-2 rounded-lg hover:bg-red-50 text-red-600" title="X√≥a vƒ©nh vi·ªÖn">‚úï</button>
    `;
  }

  function renderAll() {
    renderYears();
    renderTabs();
    renderList();
  }

  function syncAfterYearChange() {
    renderAll();
  }

  // ====== MODALS ======
  function openYearModal() {
    $("newYearInput").value = state.selectedYear + 1;
    show($("yearModal"));
  }

  function closeYearModal() { hide($("yearModal")); }

  function openSessionModal(session=null) {
    const isEdit = !!session;
    $("sessionModalTitle").textContent = isEdit ? "C·∫≠p nh·∫≠t ƒê·ª£t Ki·ªÉm K√™" : "T·∫°o ƒê·ª£t Ki·ªÉm K√™ M·ªõi";
    $("formDate").value = isEdit ? session.date : `${state.selectedYear}-01-01`;
    $("formTitle").value = isEdit ? (session.title||"") : "";
    const scopeSel = $("formScope");
    scopeSel.innerHTML = [
      `<option value="To√†n b·ªô">To√†n b·ªô ƒë∆°n v·ªã</option>`,
      ...uniqueDepartments().map(d=>`<option value="${d}">${d}</option>`)
    ].join("");
    scopeSel.value = isEdit ? (session.scope||"To√†n b·ªô") : "To√†n b·ªô";
    $("formParticipants").value = isEdit ? (session.participants||"") : (state.currentUser?.name || "");
    $("sessionModal").dataset.editingId = isEdit ? session.id : "";
    show($("sessionModal"));
  }
  function closeSessionModal() { hide($("sessionModal")); $("sessionModal").dataset.editingId=""; }

  function openView(session) {
    // deep copy
    state.viewing = JSON.parse(JSON.stringify(session));
    $("viewTitle").textContent = state.viewing.title || "";
    $("viewMeta").textContent = `${fmtDate(state.viewing.date)} - ${state.viewing.scope || ""}`;
    $("modalSearch").value = "";
    renderViewItems();
    show($("viewModal"));
  }
  function closeView() { hide($("viewModal")); state.viewing=null; }

  function renderViewItems() {
    const s = state.viewing;
    if (!s) return;
    const q = ($("modalSearch").value || "").toLowerCase();
    const items = (s.items||[]).filter(it=>{
      if (!q) return true;
      return (it.equipmentName||"").toLowerCase().includes(q) || (it.equipmentCode||"").toLowerCase().includes(q);
    });

    $("itemsCount").textContent = `T·ªïng: ${items.length} thi·∫øt b·ªã`;
    $("itemsTbody").innerHTML = items.map((it, idx)=>`
      <tr class="hover:bg-gray-50 text-xs">
        <td class="p-2 border-r text-center">${idx+1}</td>
        <td class="p-2 border-r font-medium text-sm">${it.equipmentName||""}</td>
        <td class="p-2 border-r font-mono font-bold text-gray-700">${it.equipmentCode||""}</td>
        <td class="p-2 border-r">
          <div class="truncate max-w-[120px]">${it.model||"-"}</div>
          <div class="font-mono text-gray-500 text-[10px] truncate max-w-[120px]">${it.serial||"-"}</div>
        </td>
        <td class="p-2 border-r text-center">${it.unit||"-"}</td>
        <td class="p-2 border-r text-center">${it.yearOfUse||"-"}</td>
        <td class="p-2 border-r text-right font-mono">${it.price ? Number(it.price).toLocaleString("vi-VN") : "-"}</td>
        <td class="p-2 border-r text-[10px]">
          <div class="truncate max-w-[100px]">${it.fundingSource||""}</div>
          <div class="text-blue-700 font-medium truncate max-w-[100px]">${it.usingDepartment||""}</div>
        </td>
        <td class="p-2 border-r text-[10px]">
          <div class="truncate max-w-[100px]">${it.manager||""}</div>
          <div class="text-gray-500 truncate max-w-[100px]">${it.receiver||""}</div>
        </td>
        <td class="p-2 border-r text-center font-bold text-gray-600">${it.systemQty ?? ""}</td>

        <td class="p-2 border-r bg-blue-50/20">
          <input data-it="${it.equipmentId}" data-field="actualQty" type="number"
            class="w-full text-center border-gray-300 rounded p-1 text-sm font-bold"
            value="${it.actualQty ?? 0}" ${s.type==="LIQUIDATION" ? "disabled" : ""} />
        </td>
        <td class="p-2 border-r bg-blue-50/20">
          <select data-it="${it.equipmentId}" data-field="status"
            class="w-full p-1 rounded border-gray-300 text-xs font-bold"
            ${s.type==="LIQUIDATION" ? "disabled" : ""}>
            ${["MATCH","MISMATCH","MISSING","DAMAGED","LIQUIDATED"].map(v=>`<option value="${v}" ${it.status===v?"selected":""}>${labelStatus(v)}</option>`).join("")}
          </select>
        </td>
        <td class="p-2 bg-blue-50/20">
          <input data-it="${it.equipmentId}" data-field="note"
            class="w-full border-gray-300 rounded p-1 text-xs"
            value="${escapeHtml(it.note||"")}" placeholder="..."
            ${s.type==="LIQUIDATION" ? "disabled" : ""}/>
        </td>
      </tr>
    `).join("");

    // bind change
    $("itemsTbody").querySelectorAll("input[data-it], select[data-it]").forEach(el=>{
      el.onchange = ()=>{
        const id = el.dataset.it;
        const field = el.dataset.field;
        const v = (el.tagName==="SELECT") ? el.value : (field==="actualQty" ? Number(el.value) : el.value);
        const item = (s.items||[]).find(x=>x.equipmentId===id);
        if (item) item[field] = v;
      };
    });
  }

  function labelStatus(v) {
    if (v==="MATCH") return "Kh·ªõp";
    if (v==="LIQUIDATED") return "Thanh l√Ω";
    if (v==="MISMATCH") return "Sai l·ªách";
    if (v==="MISSING") return "Th·∫•t l·∫°c";
    if (v==="DAMAGED") return "H∆∞ h·ªèng";
    return v;
  }

  function escapeHtml(str) {
    return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function openDelete(id, hard=false) {
    state.deleteTargetId = id;
    $("deleteModal").dataset.hard = hard ? "1" : "0";
    show($("deleteModal"));
  }
  function closeDelete() { hide($("deleteModal")); state.deleteTargetId=null; }

  // ====== EXCEL ======
  function exportSessionExcel(session) {
    if (!window.XLSX) return alert("Thi·∫øu th∆∞ vi·ªán XLSX.");
    const headers = ["TT","T√™n Thi·∫øt B·ªã","M√£ s·ªë","Model","Serial","ƒêVT","SL S·ªï","NƒÉm SD","Nguy√™n gi√°","CB nh·∫≠n TS","Ng∆∞·ªùi qu·∫£n l√Ω","Ngu·ªìn v·ªën","ƒê∆°n v·ªã SD","SL Th·ª±c","K·∫øt qu·∫£","Ghi ch√∫"];
    const rows = (session.items||[]).map((it,i)=>[
      i+1, it.equipmentName, it.equipmentCode, it.model||"", it.serial||"",
      it.unit||"", it.systemQty, it.yearOfUse||"", it.price||"", it.receiver||"", it.manager||"",
      it.fundingSource||"", it.usingDepartment||"", it.actualQty, labelStatus(it.status), it.note||""
    ]);
    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "KiemKe");
    XLSX.writeFile(wb, `kiem_ke_${session.date}.xlsx`);
  }

  function exportMasterExcel() {
    if (!window.XLSX) return alert("Thi·∫øu th∆∞ vi·ªán XLSX.");
    const sessions = filteredSessions();
    const headers = ["STT","Ng√†y ki·ªÉm k√™","T√™n ƒë·ª£t","Ph·∫°m vi","Ng∆∞·ªùi tham gia","Tr·∫°ng th√°i","Lo·∫°i","Ghi ch√∫"];
    const rows = sessions.map((s,i)=>[
      i+1, fmtDate(s.date), s.title, s.scope, s.participants, (s.status==="COMPLETED"?"Ho√†n th√†nh":"ƒêang m·ªü"),
      (s.type==="LIQUIDATION"?"Thanh l√Ω":"ƒê·ªãnh k·ª≥"), s.notes||""
    ]);
    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DanhSach");
    XLSX.writeFile(wb, `DanhSach_KiemKe_Nam${state.selectedYear}.xlsx`);
  }

  // ====== API ======
  async function apiCreateSession(payload) {
    const r = await fetch("/api/inventory/sessions", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if (!r.ok) return alert(data?.message || "L·ªói t·∫°o ƒë·ª£t.");
    state.sessions = data.sessions;
    renderAll();
  }

  async function apiUpdateSession(id, payload) {
    const r = await fetch(`/api/inventory/sessions/${encodeURIComponent(id)}`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if (!r.ok) return alert(data?.message || "L·ªói c·∫≠p nh·∫≠t.");
    state.sessions = data.sessions;
    renderAll();
    if (state.viewing && state.viewing.id===id) {
      // refresh viewing copy
      const fresh = state.sessions.find(x=>x.id===id);
      if (fresh) state.viewing = JSON.parse(JSON.stringify(fresh));
      renderViewItems();
    }
  }

  async function apiSoftDelete(id) {
    const r = await fetch(`/api/inventory/sessions/${encodeURIComponent(id)}/delete`, { method:"POST" });
    const data = await r.json();
    if (!r.ok) return alert(data?.message || "L·ªói x√≥a.");
    state.sessions = data.sessions;
    renderAll();
  }

  async function apiRestore(id) {
    const r = await fetch(`/api/inventory/sessions/${encodeURIComponent(id)}/restore`, { method:"POST" });
    const data = await r.json();
    if (!r.ok) return alert(data?.message || "L·ªói kh√¥i ph·ª•c.");
    state.sessions = data.sessions;
    renderAll();
  }

  async function apiDestroy(id) {
    const r = await fetch(`/api/inventory/sessions/${encodeURIComponent(id)}`, { method:"DELETE" });
    const data = await r.json();
    if (!r.ok) return alert(data?.message || "L·ªói x√≥a vƒ©nh vi·ªÖn.");
    state.sessions = data.sessions;
    renderAll();
  }

  async function apiCleanYear(year) {
    const r = await fetch(`/api/inventory/clean/${year}`, { method:"POST" });
    const data = await r.json();
    if (!r.ok) return alert(data?.message || "L·ªói d·ªçn d·ªØ li·ªáu.");
    state.sessions = data.sessions;
    alert(`ƒê√£ chuy·ªÉn ${data.count} ƒë·ª£t ki·ªÉm k√™ c·ªßa nƒÉm ${year} v√†o th√πng r√°c.`);
    renderAll();
  }

  // ====== EVENTS ======
  window.addEventListener("DOMContentLoaded", ()=>{
    // initial year = latest available
    const yrs = availableYears();
    state.selectedYear = yrs[0] || new Date().getFullYear();

    $("searchInput").oninput = (e)=>{ state.searchTerm = e.target.value || ""; renderList(); };

    // tools menu
    const toolsBtn = $("btnTools");
    const menu = $("toolsMenu");
    if (toolsBtn && menu) {
      toolsBtn.onclick = ()=>{
        menu.classList.toggle("hidden");
      };
      document.addEventListener("click", (e)=>{
        if (!menu.contains(e.target) && e.target !== toolsBtn) hide(menu);
      });
    }

    // year modal
    const openYear = $("btnOpenYearModal");
    if (openYear) openYear.onclick = openYearModal;
    document.querySelectorAll(".btnCloseModal").forEach(b=> b.onclick = closeYearModal);
    $("btnSaveNewYear")?.addEventListener("click", ()=>{
      const y = Number($("newYearInput").value);
      if (!y || y<2000 || y>2100) return alert("Vui l√≤ng nh·∫≠p nƒÉm h·ª£p l·ªá (2000-2100).");
      if (!state.extraYears.includes(y)) state.extraYears.push(y);
      state.selectedYear = y;
      closeYearModal();
      renderAll();
    });

    // session modal
    $("btnOpenSessionModal")?.addEventListener("click", ()=>openSessionModal(null));
    document.querySelectorAll(".btnCloseSessionModal").forEach(b=> b.onclick = closeSessionModal);

    $("btnSaveSession")?.addEventListener("click", async ()=>{
      const editingId = $("sessionModal").dataset.editingId || "";
      const title = $("formTitle").value.trim();
      const date = $("formDate").value;
      const scope = $("formScope").value;
      const participants = $("formParticipants").value;

      if (!title) return alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ª£t ki·ªÉm k√™.");
      if (!date) return alert("Vui l√≤ng ch·ªçn ng√†y.");

      if (editingId) {
        const old = state.sessions.find(x=>x.id===editingId);
        if (!old) return alert("Kh√¥ng t√¨m th·∫•y ƒë·ª£t.");
        await apiUpdateSession(editingId, { ...old, title, date, scope, participants });
        closeSessionModal();
      } else {
        const items = buildItemsForScope(scope);
        const payload = {
          id: `inv-${Date.now()}`,
          title, date, scope, participants,
          status: "OPEN",
          type: "REGULAR",
          items,
          notes: "",
          isDeleted: false
        };
        await apiCreateSession(payload);
        closeSessionModal();
      }
    });

    // view modal
    $("btnCloseView").onclick = closeView;
    $("modalSearch").oninput = renderViewItems;

    $("btnExportSession").onclick = ()=> {
      if (!state.viewing) return;
      exportSessionExcel(state.viewing);
    };

    $("btnSaveSessionDetail")?.addEventListener("click", async ()=>{
      if (!state.viewing) return;
      await apiUpdateSession(state.viewing.id, state.viewing);
      alert("ƒê√£ l∆∞u l·∫°i c√°c thay ƒë·ªïi th√†nh c√¥ng.");
      closeView();
    });

    // delete modal
    $("btnCancelDelete").onclick = closeDelete;
    $("btnConfirmDelete").onclick = async ()=>{
      const id = state.deleteTargetId;
      if (!id) return;
      const hard = $("deleteModal").dataset.hard === "1";
      closeDelete();
      if (hard) await apiDestroy(id);
      else await apiSoftDelete(id);
    };

    // tools actions
    $("btnExportMaster")?.addEventListener("click", exportMasterExcel);
    $("btnCleanYear")?.addEventListener("click", async ()=>{
      const y = state.selectedYear;
      if (!confirm(`Chuy·ªÉn to√†n b·ªô ƒë·ª£t ki·ªÉm k√™ (tr·ª´ Thanh l√Ω) c·ªßa nƒÉm ${y} v√†o th√πng r√°c?`)) return;
      await apiCleanYear(y);
    });

    renderAll();
  });
</script>
{% endblock %}